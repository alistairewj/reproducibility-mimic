-- exam with contrast  or procedure with contrast (contrast type: intravenous or intraarterial) 
-- during first 7 days, of the first icu
-- preliminary version 10 april 18

 
DROP MATERIALIZED VIEW IF EXISTS contras_iv_ia_first_icu;
CREATE MATERIALIZED VIEW  contras_iv_ia_first_icu AS

with iepre as 
(
select iea.subject_id , iea.hadm_id , iea.icustay_id
 ,iea.intime
 ,iea.outtime
  ,  ROW_NUMBER() over (PARTITION BY iea.subject_id ORDER BY iea.intime) as rn
from  icustays iea 
)

,ie as 
(
select  ieb.hadm_id , ieb.icustay_id
 ,ieb.intime
 ,ieb.outtime
from iepre ieb 
where ieb.rn=1
)
--need to include only first icu stay


,c1 as 
(
select distinct ce.hadm_id  
--,value 
from  chartevents ce
inner join ie on ce.hadm_id = ie.hadm_id
where ce.value in
-- based on value ilike '%contrast%' or value ilike '%cta%' or value ilike '%cath%' or value ilike '%angio%' or value ilike '%corona%'
-- some values were deleted if not adequately related to (IV or IA contrast exam-procedure)
(     
'SYNCOPE;AORTIC STENOSIS CATH'
,'Chest Pain ;CAD;CATH'
,'ST ELEVATION MI;V-FIB ARREST CATH'
,'CORONARY ARTERY DISEASE CARD CATH'
,'S/P CATH;CHEST PAIN CATH'
,'NON Q MI;CHEST PAIN CATH'
,'AV FISTULA;ANGIOPLASTY'
,'CHF;Cardiomyopathy;cath'
,'FLASH PULMONARY EDEMA CATH'
,'CORONARY ARTERY DISEASE; CATH'
,'MITRAL STENOSIS CATH'
,'CORONARY ARTERY DISEASE/CATH'
,'S/P NON Q MI CATH'
,'SOB;+ETT CATH'
,'AVR LEFT HEART CATHETERIZATION/SDA'
,'SUPRAVENTRICULAR TACHYCARDIA CATH'
,'AORTIC ANEURYSM CATH'
,'CHEST PAIN;ANGINA CATH'
,'NON Q MI;PULMONART EDEMA CATH'
,'Ascending Aorta Aneurysm/Cath'
,'CHEST PAIN,FOR CABG CATH'
,'Cardiac Cath'
,'INFERIOR MYOCARIDL INFARCTION/CATH'
,'PERSANTINE, CONTRAST'
,'APICAL ISCHEMIA CATH'
,'ACUTE MYOCARDIAL INFARCTION CATH'
,'CHEST PAIN,CAD ANGIOPLASTY'
,'CHEST PAIN; ACUTE MI CATH'
,'UNSTABLE ANGINA;ABNORMAL ECHO CATH'
,'POST INFARCT ANGINA CATH'
,'AORTIC INSUFFIENCY CATH'
,'RECURRENT ANGINA CATH'
,'IMI CATH'
,'ACUTE CORONARY SYNDROME CATH'
,'CONTRAST DYE REACTION'
,'RECURRENT ANGINA CARDIAC CATH'
,'MYOCARDIAL INFARCTION/CATH'
,'PVD LOWER EXTREMITY ANGIOGRAM'
,'STE MI CATH'
,'CP,+ETT LEFT HEART CATHETERIZATION'
,'SUBACUTE MYOCARDIAL INFARCTION CATH'
,'contrast dye,shellfish'
,'CHEST PAIN;UNSTABLE ANGINA CATH'
,'Mitral Regurgitation/Cath'
,'CRITICAL AORTIC STENOSIS CATH'
,'+ETT;DYSPNEA CATH'
,'CHEST PAIN;DYSPNEA CATH'
,'CHEST PAIN;+MYOVIEW CATH'
,'S/P CATH;?CABG CATH'
,'+ETT/CATH/BALLOON PUMP/?CABG CATH'
,'ANEMIA CATH'
,'ANGINA;+STRESS TEST CATH'
,'CARDIAC DISEASE;CATH'
,'ANGINA LEFT HEART CATHETERIZATION'
,'CHEST PAIN;+ STRESS TEST CATH'
,'S/P CATH CATH'
,'CORONARY ARTERY DISEASE;MR CATH'
,'ACUTE MYOCARDIAL INFARCTION/CATH'
,'PERSISTENT ANGINA CATH'
,'CAD,FOR CABG CATH'
,'NON Q WAVE MI CATH'
,'NON ST MI CATH'
,'CAD;AORTIC STENOSIS;CATH'
,'CHEST TIGHTNESS CATH'
,'NON Q MI CATH'
,'CHEST PAIN/ CATH'
,'CHEST PAIN; SOB CATH'
,'VF ARREST CATH'
,'CAD/+ETT CATH'
,'CHEST PAIN CATH'
,'CATH'
,'CHEST PAIN;HEART FAILURE CATH'
,'CHF,+ETT LEFT HEART CATHETERIZATION'
,'IV CONTRAST'
,'PRE OP AVR;MVR CATH'
,'MYOCARDIAL INFARCTION S/P CATH'
,'mitral regurgitation/cath'
,'SHORTNESS OF BREATH CATH'
,'R/O MI/CATH'
,'CHEST PAIN,+ETT CATH'
,'CT CONTRAST'
,'CP.+ETT LEFT HEART CATHETERIZATION'
,'SYNCOPE CATH'
,'MYOCARDIAL INFARCTION;+ETT CATH'
,'AORTIC STENOSIS CATH/SDA'
,'VENTRICULAR FIBRILLATION  CATH'
,'UNSTABLE ANGINA CARD CATH'
,'CAD, CATH'
,'NON ST ELEVATION MI CATH'
,'+ETT;CORONARY ARTERY DISEASE CATH'
,'UNSTABLE ANGINA;+ETT CATH'
,'CAD/CATH CATH'
,'carotid angio'
,'ACUTE MIU CATH'
,'Exertional Angina/Cath'
,'DYSPNEA, CAD CATH'
,'S/P MI LEFT HEART CATHETERIZATION'
,'CORONARY ARTERY DISEASE STENT'
,'IV Contrast'
,'NQW MI LEFT HEART CATHETERIZATION'
,'CHF EXACERBATION/CATH'
,'MYOCARDIAL INFARCTION CARDIAC CATH'
,'EXERTIONAL ANGINA CATH'
,'INFERIOR MYOCARDIAL INFARCTION CATH'
,'POSITIVE ETT CATH'
,'CARDIOMYOPATHY RIGHT HEART CATH'
,'AORTIC VALVE DISEASE CATH'
,'AORTIC STENOSIS, CATH'
,'AAA Right & Left Heart Cath'
,'S/P CATH'
,'STEMI;CARDIAC CATH'
,'PULMONARY EDEMA CATH'
,'CORONARY ARTERY DISEASE ANGIOPLASTY'
,'PULMONARY EDEMIA CATH'
,'CHEST PAIN ANGIOPLASTY'
,'EXERCIONAL CHEST PAIN CATH'
,'Atrial Septal Defect/Cath'
,'ABDOMINAL AORTIC ANEURYSM CATH'
,'CARDIOGENIC SHOCK;CATH'
,'Non-St Segment Elevation /Cath'
,'CORONARY ARTERY DISEASE;+ ETT CATH'
,'AORTIC STENOSIS RIGHT AND LEFT CATH'
,'ANTERIOR MI CATH'
,'ACUTE MI LEFT HEART CATHETERIZATION'
,'CHEST PAIN;+ETT CARDIAC CATH'
,'CAD/UNSTABLE ANGINA/CATH'
,'+ETT CARDIAC CATHERIZATION'
,'MI CATH'
,'ANGIO ADEMA'
,'CHEST PAIN L HEART CATH'
,'CHAST PAIN CATH'
,'HYPERTROPHIC CARDIOMYOPATHY/CATH'
,'CHEST PAIN;ABNORMAL ETT CATH'
,'PCN, CONTRAST DYE.'
,'ANGINA;CHEST PRESSURE;+ETT CATH'
,'CORONARY ARTERY DISEASE;+ETT CATH'
,'ISCHEMIC CHANGES CARD CATH'
,'+ETT LEFT HEART CATHETERIZATION'
,'AORTIC ANEURYSM CARDIAC CATH'
,'CARDIAC ARREST CATH'
,'ANGINA;LAD DESION CATH'
,'BOVINE MITRAL VALVE CATH/SDA'
,'AVR CATH'
,'S/P INFERIOR MI CATH'
,'all contrast dyes'
,'CAROTID STENOSIS CARITID ANGIO'
,'?IV contrast'
,'PULMONARY HTN CATH'
,'ABNORMAL EKG CATH'
,'S/P MYOCARDIAL INFARCTION CATH'
,'CAROTID STENOSIS CAROTID ANGIO'
,'ANEYRYSM CATH'
,'CHEST PAIN;POST INFARCT ANGINA CATH'
,'Pre-Sep Catheter'
,'Aortic Insufficiency/Cath'
,'CLAUDICATION/L LEG ANGIO'
,'S/P CARDIAC CATH PLACEMENT'
,'CHEST PAIN/ CARDIAC CATH'
,'ANGINA COMPLETE HEART CATH'
,'CHEST PAIN/CAD/CATH'
,'ST ELEVATION MI CATH'
,'S/P RIGHT GROIN EXPLORATION;? ANGIO'
,'STEMI/CATH'
,'contrast dye'     
,'STEMI CARDIAC CATHERIZATION'
,'ANGINA;+ STRESS TEST CATH'
,'CHEST PAIN/CATH'
,'CHEST PAIN; CAD CATH'
,'CAD;ChestPain;Cath'
,'STEMI CARDIAC CATH'
,'UNSTABLE ANGINA ANGIOPLASTY'
,'CAROTID,STENOSIS CAROTID ANGIOGRAM'
,'CAD,Exertional Angina,ETT/CATH'
,'CARDIAC ARREST CATHETERIZATION'
,'PVD PARIPHERAL ANGIOGRAM'
,'L ANEURYSM,S/P ANGIOGRAM'
,'DYSPNEA RIGHT + LEFT HEART CATH'
,'INSTEMI CARDIAC CATH'
,'S/P CARDIAC ARREST;CATH LAB'
,'NON Q MI;VTACH CATH'
,'S/P MI CATH'
,'RIGHT&LEFT HEART CATH'
,'CAD/R HEART CATH'
,'CHEST PAIN/S/P CATH'
,'MYOCARDIAL INFARCTION CARDICA CATH'
,'CHEST PAIT;+ETT CATH'
,'INFERIOR LATERAL MI CATH'
,'CATH LAB'
,'GI BLEED/CATH'
,'CORATID STENOSIS CAROTIS ANGIOGRAM'
,'Contrast dye'
,'+MIBI;CATH;DEHYDRATION CATH'
,'R/O MI FOR CATH'
,'+ETT CATH'
,'CHEST PAIN-STEMI CARDIAC CATH'
,'CARDIOMYOPATHY;MI CATH'
,'MI/S/P TRANSPLANT CATH'
,'S/P NQW LEFT HEART CATHETERIZATION'
,'CARDIAC CATH S/P CARDIAC ARREST'
,'CARDIAC CATH/ANGIOPLASTY'
,'MITRAL REGURGITATION CATH/SDA'
,'AORTIC STENOSIS/STENT/ CATH'
,'PD catheter'
,'CHEST PAIN;NON Q MI CATH'
,'NEW ONSET ANGINA CATH'
,'RULE OUT MYOCARDIAL INFARCTION CATH'
,'DYSPNEA CATH'
,'Straight Cath'
,'ACUTE MI CATH'
,'CONGESTIVE HEART FAILURE;MR CATH'
,'R/O CAD; CARDIAC CATH'
,'demerol,ivpcontrast'
,'CHEST PAIN,S/P CATH'
,'CHEST PAIN; CATH'
,'RENAL ANGIOPLASTY'
,'CHEST PAIN;CATH LAB'
,'CHEST PAIN;ATRIAL FIBRILLATION CATH'
,'USA,SEVERE MR CATH'
,'AHF CATH'
,'Angiography'
,'MYOCARDIAL INFARCTION;DYSPNEA CATH'
,'CORONARY ARTERY DISEASE RCA STENT'
,'ANGINA;+ETT CATH'
,'SP CABG CATH'
,'V-FIB ARREST CATH'
,'CADES CATH'
,'ANTERIOR MI LEFT HEART CATH'
,'S/P CARDIAC CATH'
,'CAD,ASPIRIN ALLERGY CATH'
,'LEFT HEART CATHETE'
,'MYOCARDIAL INFARCTION  CATH'
,'PVD LEFT LEG ANGIO'
,'+ETT; CHEST PAIN CATH'
,'AORTIC STENOSIS/CORONARY ANGIOGRAM'
,'HYPOTENSION-BLEEDING CATH SITE'
,'UNSTABLE ANGINA/CATH'
,'CHEST PAIN;+STRESS TEST CATH'
,'S/P V - FIB ARREST/ CATH'
,'Coronary Artery Disease;Aortic Sten'
,'CAROTID CATH'
,'ISCHEMIC CARDIOMYOPATHY CATH'
,'CARDIAC ARREST CARDIAC CATH'
,'UNSTABLE ANGINA CATH'
,'CAD/CATH'
,'?CAD CARDIAC CATH'
,'AFIB/CATH'
,'CHEST PAIN/CATH GROIN BLEED'
,'ATYPICAL CHEST PAIN CATH'
,'UNSTABLE ANGINA LEFT HEART CATH'
,'CORONARY ARTERY DISEASE CATH'
,'CONTRAST DYE'
,'PVD RIGHT LEG ANGIO'
,'MI L HEART CATH'
,'Angio Seal'
,'CAROTID STENOSIS CAROTID ANGIOGRAM'
,'S/P CATH GROIN BLEED'
,'AORTIC REGURG/AFIB/L HEART CATH'
,'NON ST ELEVATION MI, CATH'
,'CHEST PAIN;EKG CHANGES CATH'
,'S/P CARDIAC ARREST CATH'
,'ACUTE PULMONARY EDEMA/MI CATH'
,'Angioseal'
,'CAD,CHF,S/P V-FIB ARREST,S/P CATH'
,'ANGINA CATH'
,'ETT CATH'
,'CARDIAC CATH'
,'3 VESSEL DISEASE;+ETT CATH'
,'SYNCOPY LEFT HEART CATHETERIZATION'
,'SOB/CATH'
,'CHEST PAIN;+MI CATH'
,'ENDOCARDITIS CATH'
,'CAD/ANGIOPLASTY AND STENT'
,'CHEST PAIN;+ETT CATH'
,'S/P Myocardial Infarction;Cath'
,'CLAUDICATOIN CATH'
,'UNSTABLE ANGINA;CHEST PAIN CATH'
,'AORTIC INSUFFICIENCY CATH'
,'PVD LEFT LEG ANGIOGRAM'
,'CORONARY ARTERY DISEASE;ANGINA CATH'
,'UNSTABLE ANGINA;NON Q WAVE MI CATH'
,'+ MI CATH'
,'INTERIOR MI/CATH'
,'ISCHEMIA CATH'
,'ST WAVE MYOCARDIAL INFARCTION CATH'
,'-=0=ESTIVE HEART FAILURE CATH'
,'ST ELEVATION CATH'
,'NEW ONSET CGEST PAIN CATH'
,'MI/CATH'
,'CHEST PAIN;+ ETT CATH'
,'SEVERE AORTIC STENOSIS CATH'
,'CAROTID ANGIOGRAM CAROTID ANGIOGRAM'
,'iodinated contrast, PCN, quinine,'
,'NON Q MI;+ETT CATH'
,'SYSTOLIC DYSFUNCTION CATH'
,'CLAUDICATION,ILIAC ANGIO W/SWAN GAN'
,'CARDIOGENIC SHOCK CATH'
,'ACUTE PULMONARY EDEMA CATH'
,'NON Q MI;COPD CATH'
,'Unstable Angina,Chest Pain/cath'
,'CORONARY ARTERY DISEASE ARDIAC CATH'
,'ANGINA;CHEST PAIN CATH'
,'VTACH CATHERIZATION'
,'UNSTABLE ANGINA;TELEMETRY CATH'
,'EXERTIONAL ANGIA;CATH'
,'+ETT/CATH'
,'+ETT;ANGINA CATH'
,'CHEST PAIN;+ ETT;ANGINA CATH'
,'ABNORMAL EKG/CATH'
,'NON Q WAVE MI;HYPOTENSION CATH'
,'CAROTIS STENOSIS CAROTID ANGIOGRAM'
,'CHEST PAIN CARDIAC CATH'
,'CORONARY ARTERY DISEASE CATH; CABG'
,'ChestPain/CAD/CATH'
,'EVOLVING MI CATH'
,'MITRAL STENOSIS ANGIOPLASTY'
,'MYOCARDIAL INFARCTION ANGIOPLASTY'
,'STEMI CATH'
,'+ETT;UNSTABLE ANGINA CATH'
,'AORTIC STENOSIS CARDIAC CATH'
,'ANGINA;+ ETT CARDIAC CATH'
,'ANTERIOR MI CARDIAC CATH'
,'CHEST PAIN;S/P SEIZURE CATH'
,'CHF CATH'
,'ANGINA CARDIAC CATH'
,'Torso rash after cardia cath'
,'INTERIOR MYOCARDIAL INFARCTION;CATH'
,'Coronary Artery Disease/cath'
,'Mushroom Cath'
,'ANGINA CATH WITH ? BRACHY THERAPY'
,'S/P CHEST CONTUSION/CATH'
,'R/O CAD;CHEST PAIN CARDIAC CATH'
,'HUPERTROPHIC CARDIOMYOPATHY CATH'
,'ACUTE,MI CATH'
,'UNSTABLE ANGINA CATHETER'
,'CONGESTIVE HEART FAILURE CATH'
,'CARDIOMYOPATHY CATH'
,'CONGESTIVE HEART FAILURE CATH/SDA'
,'ASCENDING AORTIC ARCH THROMBUS CATH'
,'AS CAD CATH-COMPLETE HEART CATH'
,'MITRAL REGURGITATION CARDIAC CATH'
,'S/P INFARCT CARDIAC CATH'
,'INFERIOR MI CARDIAC CATH'
,'MYOCARDIAL INFARCTION CATH'
,'+ ETT LEFT HEART CATHETERIZATION'
,'CHF/CATH'
,'+ETT;CHEST PAIN CATH'
,'MITRAL REGURGITATION CATH'
,'AORTIC STENOSIS CATH'
,'STEMI;CATH CATH'
,'CHF/ANGIOPLASTY'
,'S/P NQMI CATH'
,'ANGINA ANGIOPRAM/ANGIOPLASTY'
,'NON Q WAVE MI CARDIAC CATH'
,'S/P MI/CATH'
,'RECURRENT CHEST PAIN CATH'
,'PERICARDIAL EFFUSION CATH'
,'UNSTABLE ANGINA;S/P MI CATH'
,'VENTRICULAR TACHYCARDIA CATH'
,'UNSTABLE ANGINA CARDIAC CATH'
,'ANGINA/CATH'
,'POST ANGIOGRAM'
,'AV BLOCK; CARDIAC CATH'
,'PVD LEFT HEART CATHETERIZATION'
,'CONTRAST DYE,SHELLFISH'
,'MYOCARDIAL INFARCTION/CARDIAC CATH'
,'CHEST PAIN;CATH'
,'UNSTABLE ANGINA COMPLETE HEART CATH'
,'SHORTNESS OF BREATH;ISCHEMIA CATH'
,'POLYMORPHIC V TACH CATH'
,'ANGINA;SHORTNESS OF BREATH CATH/SDA'
,'CHF/R HEART CATH'
,'Chest Pain;CATH'
,'CAD/CATH/PRE SYNCOPE +ETT'
)
and ce.charttime between ie.intime - interval '6' hour and ie.intime + interval '7' day
--    OR 
 -- if charttime is not available, use chartdate
---(charttime is null and chartdate between intime - interval '6' hour and intime + interval '7' day) 
)

select ie.icustay_id 
,case 
  when c1.hadm_id is not null then 1
else 0 end as contrast
from ie
left join c1 on   ie.hadm_id =  c1.hadm_id
order by ie.icustay_id ;
